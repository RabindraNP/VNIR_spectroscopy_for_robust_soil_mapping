<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 9 Spatial modeling | R code for Robust soil mapping at the farm scale with vis-NIR spectroscopy (Ramirez-Lopez et al., 2019)</title>
  <meta name="description" content="Here you will find all the code necessary to reproduce the methods we used in our paper ‘Robust soil mapping at the farm scale with vis-NIR spectroscopy’" />
  <meta name="generator" content="bookdown 0.11 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 9 Spatial modeling | R code for Robust soil mapping at the farm scale with vis-NIR spectroscopy (Ramirez-Lopez et al., 2019)" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Here you will find all the code necessary to reproduce the methods we used in our paper ‘Robust soil mapping at the farm scale with vis-NIR spectroscopy’" />
  <meta name="github-repo" content="l-ramirez-lopez/VNIR_spectroscopy_for_robust_soil_mapping" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 9 Spatial modeling | R code for Robust soil mapping at the farm scale with vis-NIR spectroscopy (Ramirez-Lopez et al., 2019)" />
  
  <meta name="twitter:description" content="Here you will find all the code necessary to reproduce the methods we used in our paper ‘Robust soil mapping at the farm scale with vis-NIR spectroscopy’" />
  

<meta name="author" content="Leo Ramirez-Lopez (BUCHI Labortechnik AG, Switzerland)" />
<meta name="author" content="Alex Wadoux (Wageningen University, Netherlands)" />


<meta name="date" content="2019-06-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="prepare-the-vis-nir-augmented-dataset.html">
<link rel="next" href="references.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.2/leaflet.js"></script>
<script src="libs/leaflet-providers-1.1.17/leaflet-providers.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.2/leaflet-providers-plugin.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil mapping with VNIR</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#paper-summary"><i class="fa fa-check"></i><b>1.1</b> Paper summary</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#study-area"><i class="fa fa-check"></i><b>1.2</b> Study area</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#in-case-of-commentsquestionsissues"><i class="fa fa-check"></i><b>1.3</b> In case of comments/questions/issues</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#for-citation-or-details-please-refer-to"><i class="fa fa-check"></i><b>1.4</b> For citation or details please refer to:</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#notes"><i class="fa fa-check"></i><b>1.5</b> Notes</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="required-r-packages.html"><a href="required-r-packages.html"><i class="fa fa-check"></i><b>2</b> Required <code>R</code> packages</a></li>
<li class="chapter" data-level="3" data-path="required-data.html"><a href="required-data.html"><i class="fa fa-check"></i><b>3</b> Required data</a></li>
<li class="chapter" data-level="4" data-path="sampling.html"><a href="sampling.html"><i class="fa fa-check"></i><b>4</b> Sampling</a><ul>
<li class="chapter" data-level="4.1" data-path="sampling.html"><a href="sampling.html#optimal-calibration-set-size-identification"><i class="fa fa-check"></i><b>4.1</b> Optimal calibration set size identification</a></li>
<li class="chapter" data-level="4.2" data-path="sampling.html"><a href="sampling.html#plotting-the-results"><i class="fa fa-check"></i><b>4.2</b> Plotting the results</a></li>
<li class="chapter" data-level="4.3" data-path="sampling.html"><a href="sampling.html#final-selection-of-the-calibration-set"><i class="fa fa-check"></i><b>4.3</b> Final selection of the calibration set</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="splitting-the-data.html"><a href="splitting-the-data.html"><i class="fa fa-check"></i><b>5</b> Splitting the data</a></li>
<li class="chapter" data-level="6" data-path="transformation-of-the-particle-size-data.html"><a href="transformation-of-the-particle-size-data.html"><i class="fa fa-check"></i><b>6</b> Transformation of the particle-size data</a></li>
<li class="chapter" data-level="7" data-path="visnir-modelling-and-predictions.html"><a href="visnir-modelling-and-predictions.html"><i class="fa fa-check"></i><b>7</b> Vis–NIR modelling and predictions</a><ul>
<li class="chapter" data-level="7.1" data-path="visnir-modelling-and-predictions.html"><a href="visnir-modelling-and-predictions.html#calibration-and-validation"><i class="fa fa-check"></i><b>7.1</b> Calibration and validation</a></li>
<li class="chapter" data-level="7.2" data-path="visnir-modelling-and-predictions.html"><a href="visnir-modelling-and-predictions.html#property-predictions-in-the-prediction-set"><i class="fa fa-check"></i><b>7.2</b> Property predictions in the prediction set</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="prepare-the-vis-nir-augmented-dataset.html"><a href="prepare-the-vis-nir-augmented-dataset.html"><i class="fa fa-check"></i><b>8</b> Prepare the vis-NIR augmented dataset</a></li>
<li class="chapter" data-level="9" data-path="spatial-modeling.html"><a href="spatial-modeling.html"><i class="fa fa-check"></i><b>9</b> Spatial modeling</a><ul>
<li class="chapter" data-level="9.1" data-path="spatial-modeling.html"><a href="spatial-modeling.html#robust-fitting-of-the-spatial-models"><i class="fa fa-check"></i><b>9.1</b> Robust fitting of the spatial models</a><ul>
<li class="chapter" data-level="9.1.1" data-path="spatial-modeling.html"><a href="spatial-modeling.html#laboratory-based-data"><i class="fa fa-check"></i><b>9.1.1</b> Laboratory-based data</a></li>
<li class="chapter" data-level="9.1.2" data-path="spatial-modeling.html"><a href="spatial-modeling.html#augmented-vis-nir-data"><i class="fa fa-check"></i><b>9.1.2</b> Augmented vis-NIR data</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="spatial-modeling.html"><a href="spatial-modeling.html#accounting-for-vis-nir-model-errors-in-the-spatial-models"><i class="fa fa-check"></i><b>9.2</b> Accounting for vis-NIR model errors in the spatial models</a></li>
<li class="chapter" data-level="9.3" data-path="spatial-modeling.html"><a href="spatial-modeling.html#validation-of-the-spatial-models"><i class="fa fa-check"></i><b>9.3</b> Validation of the spatial models</a><ul>
<li class="chapter" data-level="9.3.1" data-path="spatial-modeling.html"><a href="spatial-modeling.html#laboratory-based-data-1"><i class="fa fa-check"></i><b>9.3.1</b> Laboratory-based data</a></li>
<li class="chapter" data-level="9.3.2" data-path="spatial-modeling.html"><a href="spatial-modeling.html#vis-nir-augmented-based-data"><i class="fa fa-check"></i><b>9.3.2</b> Vis-NIR augmented-based data</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="spatial-modeling.html"><a href="spatial-modeling.html#mapping"><i class="fa fa-check"></i><b>9.4</b> Mapping</a><ul>
<li class="chapter" data-level="9.4.1" data-path="spatial-modeling.html"><a href="spatial-modeling.html#laboratory-based-data-2"><i class="fa fa-check"></i><b>9.4.1</b> Laboratory-based data</a></li>
<li class="chapter" data-level="9.4.2" data-path="spatial-modeling.html"><a href="spatial-modeling.html#vis-nir-augmented-based-data-1"><i class="fa fa-check"></i><b>9.4.2</b> Vis-NIR augmented-based data</a></li>
<li class="chapter" data-level="9.4.3" data-path="spatial-modeling.html"><a href="spatial-modeling.html#plots"><i class="fa fa-check"></i><b>9.4.3</b> Plots</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">End</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R code for Robust soil mapping at the farm scale with vis-NIR spectroscopy (Ramirez-Lopez <em>et al.</em>, 2019)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-modeling" class="section level1">
<h1><span class="header-section-number">Section 9</span> Spatial modeling</h1>
<hr />
<p>In case you have previosly saved both, the vis-NIR augmented data set and the table of the variance of the residuals into your working directory, and you do not have these data in your <code>R</code> enviroment you can execute the code below:</p>
<pre class="sourceCode r"><code class="sourceCode r">## vniraugmented.txt is spuppposed to be saved in your working directory
vniraugmented &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;vniraugmented.txt&quot;</span>, 
                            <span class="dt">header =</span> <span class="ot">TRUE</span>, 
                            <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</code></pre>
<p>If you have saved the table of the variance of the residuals into your working directory you can execute the code below:</p>
<pre class="sourceCode r"><code class="sourceCode r">## vnir_residual_variances.txt is spuppposed to be saved in your working directory
residualvariances &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;vnir_residual_variances.txt&quot;</span>, 
                                <span class="dt">header =</span> <span class="ot">TRUE</span>, 
                                <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</code></pre>
<p>Alternatively, you can clean your <code>R</code> enviroment and leave only the data that will be used for the spatial analyses:</p>
<pre class="sourceCode r"><code class="sourceCode r">## necessary objects
reqobjects2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;vniraugmented&quot;</span>, <span class="st">&quot;residualvariances&quot;</span>)

## objects to be removed
o2rm2 &lt;-<span class="st"> </span><span class="kw">ls</span>()[<span class="op">!</span><span class="kw">ls</span>() <span class="op">%in%</span><span class="st"> </span>reqobjects2]

## remove the objects
<span class="kw">rm</span>(<span class="dt">list =</span> o2rm2)</code></pre>
<p>Split the data and organize it by layers and spatial fit and validation sets</p>
<pre class="sourceCode r"><code class="sourceCode r">vniraugmented &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(vniraugmented)

## split the data sets by layer and by spatial fit and spatial validation
fitlayera &lt;-<span class="st"> </span>vniraugmented <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(layer <span class="op">==</span><span class="st"> &quot;A&quot;</span>, set <span class="op">!=</span><span class="st"> &quot;validation&quot;</span>)
fitlayerb &lt;-<span class="st"> </span>vniraugmented <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(layer <span class="op">==</span><span class="st"> &quot;B&quot;</span>, set <span class="op">!=</span><span class="st"> &quot;validation&quot;</span>)

vallayera &lt;-<span class="st"> </span>vniraugmented <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(layer <span class="op">==</span><span class="st"> &quot;A&quot;</span>, set <span class="op">==</span><span class="st"> &quot;validation&quot;</span>)
vallayerb &lt;-<span class="st"> </span>vniraugmented <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(layer <span class="op">==</span><span class="st"> &quot;B&quot;</span>, set <span class="op">==</span><span class="st"> &quot;validation&quot;</span>)

<span class="kw">plot</span>(vallayera<span class="op">$</span>POINT_X, vallayera<span class="op">$</span>POINT_Y,
     <span class="dt">xlab =</span> <span class="st">&quot;X&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;Y&quot;</span>)
<span class="kw">points</span>(fitlayera<span class="op">$</span>POINT_X, fitlayera<span class="op">$</span>POINT_Y, 
       <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, 
       <span class="dt">cex =</span> <span class="fl">1.5</span>)</code></pre>
<div id="robust-fitting-of-the-spatial-models" class="section level2">
<h2><span class="header-section-number">9.1</span> Robust fitting of the spatial models</h2>
<p>Specify some basic aspects/parameters required for fitting the spatial models…</p>
<pre class="sourceCode r"><code class="sourceCode r">## Define a lag distance for the estimation of the variagram
lagdist &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1500</span>, <span class="dt">by =</span> <span class="dv">100</span>)

## Choose the variogram model
varmodel &lt;-<span class="st"> &quot;RMexp&quot;</span>

## Define what parameters need to be adjusted to fit the geo model
fitparam &lt;-<span class="st"> </span><span class="kw">default.fit.param</span>(<span class="dt">scale =</span> <span class="ot">FALSE</span>, <span class="dt">alpha =</span> <span class="ot">TRUE</span>, <span class="dt">variance =</span> <span class="ot">FALSE</span>)

## A tuning constant for the robust REML algorithm 
## for the spatial models (see tuniing.psi parameter 
## of the  georob function)
tpsi &lt;-<span class="st"> </span><span class="dv">2000</span>

## Control some aspects of the spatial predictions
gcntrl &lt;-<span class="st"> </span><span class="kw">control.predict.georob</span>(<span class="dt">extended.output =</span> <span class="ot">TRUE</span>, 
                                 <span class="dt">full.covmat =</span> <span class="ot">TRUE</span>)</code></pre>
<p>Define the tables where the fitted variogram parameters will be stored</p>
<pre class="sourceCode r"><code class="sourceCode r">## The variables for which a spatial model will be fitted
gprops &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ca&quot;</span>, 
            <span class="st">&quot;alr_Clay&quot;</span>, 
            <span class="st">&quot;alr_Silt&quot;</span>, 
            <span class="st">&quot;Ca_spec&quot;</span>,
            <span class="st">&quot;alr_Clay_spec&quot;</span>, 
            <span class="st">&quot;alr_Silt_spec&quot;</span>)

## names of the variogram parameters
varparamames &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;variance&quot;</span>, <span class="st">&quot;snugget&quot;</span>, <span class="st">&quot;nugget&quot;</span>, <span class="st">&quot;scale&quot;</span>)

## Create the table
variogtablea &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">properties =</span> gprops,
                           <span class="dt">data =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Laboratory&quot;</span>, <span class="st">&quot;vis-NIR augmented&quot;</span>), 
                                      <span class="dt">each =</span> <span class="kw">length</span>(gprops) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>),
                           <span class="dt">variance =</span> <span class="ot">NA</span>,
                           <span class="dt">snugget =</span> <span class="ot">NA</span>,
                           <span class="dt">nugget =</span> <span class="ot">NA</span>,
                           <span class="dt">scale =</span> <span class="ot">NA</span>)
variogtableb &lt;-<span class="st"> </span>variogtablea</code></pre>
<div id="laboratory-based-data" class="section level3">
<h3><span class="header-section-number">9.1.1</span> Laboratory-based data</h3>
<p>Here we fit the spatial models of the soil properties whose values comes from conventional laboratory analyes only…</p>
<div id="layer-a" class="section level4">
<h4><span class="header-section-number">9.1.1.1</span> Layer A</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_Ca_lab_a &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayera<span class="op">$</span>Ca,
                                   <span class="dt">locations =</span> fitlayera[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                   <span class="dt">lag.dist.def =</span> lagdist, 
                                   <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_Ca_lab_a<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_Ca_lab_a<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_Ca_lab_a<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;Ca, laboratory - Layer A&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_Ca_lab_a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="dv">135</span>, 
                     <span class="dt">nugget =</span> <span class="dv">10</span>, 
                     <span class="dt">scale =</span> <span class="dv">920</span>)
## Fit 
Ca_lab_a &lt;-<span class="st"> </span><span class="kw">georob</span>(Ca <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                   <span class="dt">data =</span> fitlayera, 
                   <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                   <span class="dt">variogram.model =</span> varmodel,
                   <span class="dt">param =</span> startp_Ca_lab_a,
                   <span class="dt">fit.param =</span> fitparam,
                   <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(Ca_lab_a)

## Store the variogram parameters
variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>, varparamames] &lt;-<span class="st"> </span>Ca_lab_a<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(clay)\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Clay_lab_a &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayera<span class="op">$</span>alr_Clay,
                                         <span class="dt">locations =</span> fitlayera[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                         <span class="dt">lag.dist.def =</span> lagdist, 
                                         <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Clay_lab_a<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Clay_lab_a<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Clay_lab_a<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(clay) laboratory - Layer A&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Clay_lab_a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">0.8</span>, 
                           <span class="dt">nugget =</span> <span class="fl">0.3</span>, 
                           <span class="dt">scale =</span> <span class="dv">1220</span>)

## Fit 
alr_Clay_lab_a &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Clay <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                         <span class="dt">data =</span> fitlayera, 
                         <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                         <span class="dt">variogram.model =</span> varmodel,
                         <span class="dt">param =</span> startp_alr_Clay_lab_a,
                         <span class="dt">fit.param =</span> fitparam,
                         <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Clay_lab_a)
## Store the variogram parameters
variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Clay_lab_a<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(silt)\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Silt_lab_a &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayera<span class="op">$</span>alr_Silt,
                                         <span class="dt">locations =</span> fitlayera[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                         <span class="dt">lag.dist.def =</span> lagdist, 
                                         <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Silt_lab_a<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Silt_lab_a<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Silt_lab_a<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(silt) laboratory - Layer A&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Silt_lab_a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">1.31</span>, 
                           <span class="dt">nugget =</span> <span class="fl">0.3</span>, 
                           <span class="dt">scale =</span> <span class="dv">812</span>)

## Fit 
alr_Silt_lab_a &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Silt <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                         <span class="dt">data =</span> fitlayera, 
                         <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                         <span class="dt">variogram.model =</span> varmodel,
                         <span class="dt">param =</span> startp_alr_Silt_lab_a,
                         <span class="dt">fit.param =</span> fitparam,
                         <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Silt_lab_a)
## Store the variogram parameters
variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Silt_lab_a<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
</div>
<div id="layer-b" class="section level4">
<h4><span class="header-section-number">9.1.1.2</span> Layer B</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_Ca_lab_b &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayerb<span class="op">$</span>Ca,
                                   <span class="dt">locations =</span> fitlayerb[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                   <span class="dt">lag.dist.def =</span> lagdist, 
                                   <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_Ca_lab_b<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_Ca_lab_b<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_Ca_lab_b<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;Ca, laboratory - Layer B&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_Ca_lab_b &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="dv">127</span>, 
                     <span class="dt">nugget =</span> <span class="fl">0.1</span>, 
                     <span class="dt">scale =</span> <span class="dv">850</span>)
## Fit 
Ca_lab_b &lt;-<span class="st"> </span><span class="kw">georob</span>(Ca <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                   <span class="dt">data =</span> fitlayerb, 
                   <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                   <span class="dt">variogram.model =</span> varmodel,
                   <span class="dt">param =</span> startp_Ca_lab_b,
                   <span class="dt">fit.param =</span> fitparam,
                   <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(Ca_lab_b)
## Store the variogram parameters
variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>, varparamames] &lt;-<span class="st"> </span>Ca_lab_b<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(clay)\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Clay_lab_b &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayerb<span class="op">$</span>alr_Clay,
                                         <span class="dt">locations =</span> fitlayerb[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                         <span class="dt">lag.dist.def =</span> lagdist, 
                                         <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Clay_lab_b<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Clay_lab_b<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Clay_lab_b<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(clay) laboratory - Layer B&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Clay_lab_b &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">1.17</span>, 
                           <span class="dt">nugget =</span> <span class="fl">0.1</span>,
                           <span class="dt">scale =</span> <span class="dv">973</span>, 
                           <span class="dt">alpha =</span> <span class="fl">0.69</span>)
## Fit 
alr_Clay_lab_b &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Clay <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                         <span class="dt">data =</span> fitlayerb, 
                         <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                         <span class="dt">variogram.model =</span> varmodel,
                         <span class="dt">param =</span> startp_alr_Clay_lab_b,
                         <span class="dt">fit.param =</span> fitparam,
                         <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Clay_lab_b)
## Store the variogram parameters
variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Clay_lab_b<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(silt)\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Silt_lab_b &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayerb<span class="op">$</span>alr_Silt,
                                         <span class="dt">locations =</span> fitlayerb[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                         <span class="dt">lag.dist.def =</span> lagdist, 
                                         <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Silt_lab_b<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Silt_lab_b<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Silt_lab_b<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(silt) laboratory - Layer B&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Silt_lab_b &lt;-<span class="st">  </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">1.1</span>, 
                            <span class="dt">nugget =</span> <span class="fl">0.2</span>, 
                            <span class="dt">scale =</span> <span class="dv">423</span>)

## Fit 
alr_Silt_lab_b &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Silt <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                         <span class="dt">data =</span> fitlayerb, 
                         <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                         <span class="dt">variogram.model =</span> varmodel,
                         <span class="dt">param =</span> startp_alr_Silt_lab_b,
                         <span class="dt">fit.param =</span> fitparam,
                         <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Silt_lab_b)
## Store the variogram parameters
variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Silt_lab_b<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
</div>
</div>
<div id="augmented-vis-nir-data" class="section level3">
<h3><span class="header-section-number">9.1.2</span> Augmented vis-NIR data</h3>
<p>Here we fit the spatial models of the soil properties whose values come from the vis-NIR augmented data…</p>
<div id="layer-a-1" class="section level4">
<h4><span class="header-section-number">9.1.2.1</span> Layer A</h4>
<p>Exchangeable Ca<sup>2+</sup> (vis-NIR augmented) …</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Check the sample variogram</span>
vario_Ca_spec_a &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayera<span class="op">$</span>Ca_spec,
                                    <span class="dt">locations =</span> fitlayera[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                    <span class="dt">lag.dist.def =</span> lagdist, 
                                    <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_Ca_spec_a<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_Ca_spec_a<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_Ca_spec_a<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;Ca, vis-NIR augmented - Layer A&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_Ca_spec_a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="dv">112</span>, 
                      <span class="dt">nugget =</span> <span class="dv">1</span>, 
                      <span class="dt">scale =</span> <span class="dv">1023</span>)
## Fit 
Ca_spec_a &lt;-<span class="st"> </span><span class="kw">georob</span>(Ca <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                    <span class="dt">data =</span> fitlayera, 
                    <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                    <span class="dt">variogram.model =</span> varmodel,
                    <span class="dt">param =</span> startp_Ca_spec_a,
                    <span class="dt">fit.param =</span> fitparam,
                    <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(Ca_spec_a)
## Store the variogram parameters
variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>, varparamames] &lt;-<span class="st"> </span>Ca_spec_a<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(clay)\)</span> (vis-NIR augmented)</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Clay_spec_a &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayera<span class="op">$</span>alr_Clay_spec,
                                          <span class="dt">locations =</span> fitlayera[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                          <span class="dt">lag.dist.def =</span> lagdist, 
                                          <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Clay_spec_a<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Clay_spec_a<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Clay_spec_a<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(clay) vis-NIR augmented - Layer A&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Clay_spec_a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">1.134</span>,
                            <span class="dt">nugget =</span> <span class="fl">0.1</span>,
                            <span class="dt">scale =</span> <span class="dv">955</span>)

## Fit 
alr_Clay_spec_a &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Clay_spec <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                          <span class="dt">data =</span> fitlayera, 
                          <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                          <span class="dt">variogram.model =</span> varmodel,
                          <span class="dt">param =</span> startp_alr_Clay_spec_a,
                          <span class="dt">fit.param =</span> fitparam,
                          <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Clay_spec_a)
## Store the variogram parameters
variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Clay_spec_a<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(silt)\)</span> (vis-NIR augmented)</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Silt_spec_a &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayera<span class="op">$</span>alr_Silt_spec,
                                          <span class="dt">locations =</span> fitlayera[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                          <span class="dt">lag.dist.def =</span> lagdist, 
                                          <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Silt_spec_a<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Silt_spec_a<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Silt_spec_a<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(silt) vis-NIR augmented - Layer A&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Silt_spec_a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">0.845</span>, 
                            <span class="dt">nugget =</span> <span class="fl">0.1</span>, 
                            <span class="dt">scale =</span> <span class="dv">1282</span>)

## Fit 
alr_Silt_spec_a &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Silt_spec <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                          <span class="dt">data =</span> fitlayera, 
                          <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                          <span class="dt">variogram.model =</span> varmodel,
                          <span class="dt">param =</span> startp_alr_Silt_spec_a,
                          <span class="dt">fit.param =</span> fitparam,
                          <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Silt_spec_a)
## Store the variogram parameters
variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Silt_spec_a<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
</div>
<div id="layer-b-1" class="section level4">
<h4><span class="header-section-number">9.1.2.2</span> Layer B</h4>
<p>Exchangeable Ca<sup>2+</sup> (vis-NIR augmented) …</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_Ca_spec_b &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayerb<span class="op">$</span>Ca_spec,
                                    <span class="dt">locations =</span> fitlayerb[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                    <span class="dt">lag.dist.def =</span> lagdist, 
                                    <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_Ca_spec_b<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_Ca_spec_b<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_Ca_spec_b<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;Ca, vis-NIR augmented - Layer B&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_Ca_spec_b &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="dv">142</span>, 
                      <span class="dt">nugget =</span> <span class="fl">0.1</span>, 
                      <span class="dt">scale =</span> <span class="dv">1025</span>)
## Fit 
Ca_spec_b &lt;-<span class="st"> </span><span class="kw">georob</span>(Ca <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                    <span class="dt">data =</span> fitlayerb, 
                    <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                    <span class="dt">variogram.model =</span> varmodel,
                    <span class="dt">param =</span> startp_Ca_spec_b,
                    <span class="dt">fit.param =</span> fitparam,
                    <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(Ca_spec_b)
## Store the variogram parameters
variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>, varparamames] &lt;-<span class="st"> </span>Ca_spec_b<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(clay)\)</span> (vis-NIR augmented)</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Clay_spec_b &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayerb<span class="op">$</span>alr_Clay_spec,
                                          <span class="dt">locations =</span> fitlayerb[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                          <span class="dt">lag.dist.def =</span> lagdist, 
                                          <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Clay_spec_b<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Clay_spec_b<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Clay_spec_b<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(clay) vis-NIR augmented - Layer B&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Clay_spec_b &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">1.21</span>, 
                            <span class="dt">nugget =</span> <span class="fl">0.1</span>, 
                            <span class="dt">scale =</span> <span class="dv">1000</span>, 
                            <span class="dt">alpha =</span> <span class="fl">0.68</span>)
## Fit 
alr_Clay_spec_b &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Clay_spec <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                          <span class="dt">data =</span> fitlayerb, 
                          <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                          <span class="dt">variogram.model =</span> varmodel,
                          <span class="dt">param =</span> startp_alr_Clay_spec_b,
                          <span class="dt">fit.param =</span> fitparam,
                          <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Clay_spec_b)
## Store the variogram parameters
variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Clay_spec_b<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
<p><span class="math inline">\(alr(silt)\)</span> (vis-NIR augmented)</p>
<pre class="sourceCode r"><code class="sourceCode r">## Check the sample variogram
vario_alr_Silt_spec_b &lt;-<span class="st"> </span><span class="kw">sample.variogram</span>(<span class="dt">object =</span> fitlayerb<span class="op">$</span>alr_Silt_spec,
                                          <span class="dt">locations =</span> fitlayerb[,<span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)], 
                                          <span class="dt">lag.dist.def =</span> lagdist, 
                                          <span class="dt">estimator =</span> <span class="st">&quot;matheron&quot;</span>)
## Plot the sample variogram
<span class="kw">plot</span>(<span class="dt">x =</span> vario_alr_Silt_spec_b<span class="op">$</span>lag.dist, 
     <span class="dt">y =</span> vario_alr_Silt_spec_b<span class="op">$</span>gamma, 
     <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(vario_alr_Silt_spec_b<span class="op">$</span>gamma)),
     <span class="dt">xlab =</span> <span class="st">&quot;lag distance&quot;</span>,
     <span class="dt">ylab =</span> <span class="st">&quot;gamma&quot;</span>,
     <span class="dt">pch =</span> <span class="dv">16</span>,
     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>,
     <span class="dt">main =</span> <span class="st">&quot;alr(silt) vis-NIR augmented - Layer B&quot;</span>)
<span class="kw">grid</span>()

## Check the plot above to select some starting values of the 
## variogram parameters
startp_alr_Silt_spec_b &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">variance =</span> <span class="fl">1.43</span>, 
                            <span class="dt">nugget =</span> <span class="fl">0.1</span>, 
                            <span class="dt">scale =</span> <span class="dv">850</span>,
                            <span class="dt">alpha =</span> <span class="fl">0.63</span>)
## Fit 
alr_Silt_spec_b &lt;-<span class="st"> </span><span class="kw">georob</span>(alr_Silt_spec <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, 
                          <span class="dt">data =</span> fitlayerb, 
                          <span class="dt">locations =</span> <span class="op">~</span><span class="st"> </span>POINT_X <span class="op">+</span><span class="st"> </span>POINT_Y, 
                          <span class="dt">variogram.model =</span> varmodel,
                          <span class="dt">param =</span> startp_alr_Silt_spec_b,
                          <span class="dt">fit.param =</span> fitparam,
                          <span class="dt">tuning.psi =</span> tpsi)
<span class="kw">summary</span>(alr_Silt_spec_b)
## Store the variogram parameters
variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>, varparamames] &lt;-<span class="st"> </span>alr_Silt_spec_b<span class="op">$</span>variogram.object[[<span class="dv">1</span>]]<span class="op">$</span>param[varparamames]</code></pre>
</div>
</div>
</div>
<div id="accounting-for-vis-nir-model-errors-in-the-spatial-models" class="section level2">
<h2><span class="header-section-number">9.2</span> Accounting for vis-NIR model errors in the spatial models</h2>
<p>Our vis-NIR models (used to create the vis-NIR augmented data) have an error which we estimated in previous sections and which is stored in the <code>residualvariances</code> object. The uncertainty of these models was propagated through spatial predictions in order to obtain more realistic performance results of the spatial predictions. We followed the approach given in Viscarra Rossel et al. (2016b) where the variance of the residuals of the vis-NIR predictions at each layer is used for propagating the vis-NIR erros (see section <em>Spectroscopicmodel error</em> in our paper).
For the vis-NIR augmented data we assume that the uncertainty of the whole set is given by the variances of the predictions. However, this dataset contains both, laboratory data (aprox. 26%) and vis-NIR predicted data (aprox. 74%), therefore the variance we assume here is expected to be larger than the actual one in the augmented data. You can try to account for this.</p>
<pre class="sourceCode r"><code class="sourceCode r">## Add the residual variances to the snugget parameter
## of the variograms corresponding to the vis-NIR augmented 
## data
## Note that snugget was 0 for all the fitted variograms
## Ca (layer A)
variogtablea<span class="op">$</span>snugget[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span>residualvariances<span class="op">$</span>layerA[residualvariances<span class="op">$</span>Property <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>]
## alr(clay) (layer A)
variogtablea<span class="op">$</span>snugget[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>] &lt;-<span class="st"> </span>residualvariances<span class="op">$</span>layerA[residualvariances<span class="op">$</span>Property <span class="op">==</span><span class="st"> &quot;alr_Clay&quot;</span>]
## alr(silt) (layer A)
variogtablea<span class="op">$</span>snugget[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>] &lt;-<span class="st"> </span>residualvariances<span class="op">$</span>layerA[residualvariances<span class="op">$</span>Property <span class="op">==</span><span class="st"> &quot;alr_Silt&quot;</span>]

## Ca (layer B)
variogtableb<span class="op">$</span>snugget[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span>residualvariances<span class="op">$</span>layerB[residualvariances<span class="op">$</span>Property <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>]
## alr(clay)  (layer B)
variogtableb<span class="op">$</span>snugget[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>] &lt;-<span class="st"> </span>residualvariances<span class="op">$</span>layerB[residualvariances<span class="op">$</span>Property <span class="op">==</span><span class="st"> &quot;alr_Clay&quot;</span>]
## alr(silt) (layer B)
variogtableb<span class="op">$</span>snugget[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>] &lt;-<span class="st"> </span>residualvariances<span class="op">$</span>layerB[residualvariances<span class="op">$</span>Property <span class="op">==</span><span class="st"> &quot;alr_Silt&quot;</span>]</code></pre>
</div>
<div id="validation-of-the-spatial-models" class="section level2">
<h2><span class="header-section-number">9.3</span> Validation of the spatial models</h2>
<p>Create a <code>data.frame</code> for each layer to store the predictions in the validation set and another two to store the validation results…</p>
<pre class="sourceCode r"><code class="sourceCode r">## The final variables to be predicted. In the case of 
## Clay, silt and Sand they are estimated from the 
## predictions of alr(clay) and alr(silt)
bprops &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ca&quot;</span>, 
            <span class="st">&quot;Clay&quot;</span>, 
            <span class="st">&quot;Silt&quot;</span>, 
            <span class="st">&quot;Sand&quot;</span>, 
            <span class="st">&quot;Ca_spec&quot;</span>,
            <span class="st">&quot;Clay_spec&quot;</span>, 
            <span class="st">&quot;Silt_spec&quot;</span>, 
            <span class="st">&quot;Sand_spec&quot;</span>)

## a quick function to create columns of a given length (lg)
idfcol &lt;-<span class="st"> </span><span class="cf">function</span>(x, lg){
  <span class="kw">data.frame</span>(lg, <span class="dt">fix.empty.names =</span> <span class="ot">FALSE</span>)
}

## object where the spatial predictions will be stored 
sppredsvala &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, bprops), 
                      <span class="dt">FUN =</span> idfcol, 
                      <span class="dt">lg =</span> <span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(vallayera)))
sppredsvala &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">do.call</span>(<span class="st">&quot;cbind&quot;</span>, sppredsvala))
sppredsvala<span class="op">$</span>ID &lt;-<span class="st"> </span>vallayera<span class="op">$</span>ID

sppredsvalb &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, bprops), 
                      <span class="dt">FUN =</span> idfcol, 
                      <span class="dt">lg =</span> <span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(vallayerb)))
sppredsvalb &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">do.call</span>(<span class="st">&quot;cbind&quot;</span>, sppredsvalb))
sppredsvalb<span class="op">$</span>ID &lt;-<span class="st"> </span>vallayerb<span class="op">$</span>ID

## object where the validation of the spatial predictions will be stored 
spvala &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">properties =</span> bprops,
                     <span class="dt">data =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Laboratory&quot;</span>, <span class="st">&quot;vis-NIR augmented&quot;</span>), 
                                <span class="dt">each =</span> <span class="kw">length</span>(bprops) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>),
                     <span class="dt">R2 =</span> <span class="ot">NA</span>,
                     <span class="dt">RMSE =</span> <span class="ot">NA</span>,
                     <span class="dt">ME =</span> <span class="ot">NA</span>)
spvalb &lt;-<span class="st"> </span>spvala</code></pre>
<div id="laboratory-based-data-1" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Laboratory-based data</h3>
<div id="layer-a-2" class="section level4">
<h4><span class="header-section-number">9.3.1.1</span> Layer A</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_Ca_lab_a &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_lab_a, 
                         <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayera), 
                         <span class="dt">control =</span> gcntrl)

sppredsvala<span class="op">$</span>Ca &lt;-<span class="st"> </span>pred_Ca_lab_a<span class="op">$</span>pred<span class="op">$</span>pred

spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Ca, sppredsvala<span class="op">$</span>Ca)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Ca)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Ca)</code></pre>
<p>Estimation of clay, silt and sand contents from the predictions of <span class="math inline">\(alr(clay)\)</span> and <span class="math inline">\(alr(silt)\)</span>…</p>
<pre class="sourceCode r"><code class="sourceCode r">## predict alr(clay)
pred_alr_Clay_lab_a &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_lab_a, 
                               <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayera), 
                               <span class="dt">control =</span> gcntrl)
## predict alr(silt)
pred_alr_Silt_lab_a &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_lab_a, 
                               <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayera), 
                               <span class="dt">control =</span> gcntrl)

## Back-transfrom to clay, silt and sand contents
dvr.Silt &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Silt_lab_a<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Silt_lab_a<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Silt_lab_a<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvr.Clay &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Clay_lab_a<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Clay_lab_a<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Clay_lab_a<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvn.pred &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>dvr.Silt <span class="op">+</span><span class="st"> </span>dvr.Clay

## Store the back-transformed values
sppredsvala<span class="op">$</span>Clay &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Clay<span class="op">/</span>dvn.pred)
sppredsvala<span class="op">$</span>Silt &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Silt<span class="op">/</span>dvn.pred)
sppredsvala<span class="op">$</span>Sand &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>dvn.pred

## Estimate the validation parameters for
## Clay
spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Clay, sppredsvala<span class="op">$</span>Clay)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Clay)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Clay)
## Silt
spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Silt, sppredsvala<span class="op">$</span>Silt)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Silt)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Silt)
## Sand
spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Sand, sppredsvala<span class="op">$</span>Sand)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Sand)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Sand)</code></pre>
</div>
<div id="layer-b-2" class="section level4">
<h4><span class="header-section-number">9.3.1.2</span> Layer B</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_Ca_lab_b &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_lab_b, 
                         <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayerb), 
                         <span class="dt">control =</span> gcntrl)

sppredsvalb<span class="op">$</span>Ca &lt;-<span class="st"> </span>pred_Ca_lab_b<span class="op">$</span>pred<span class="op">$</span>pred

spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Ca, sppredsvalb<span class="op">$</span>Ca)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Ca)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Ca)</code></pre>
<p>Estimation of clay, silt and sand contents from the predictions of <span class="math inline">\(alr(clay)\)</span> and <span class="math inline">\(alr(silt)\)</span>…</p>
<pre class="sourceCode r"><code class="sourceCode r">## predict alr(clay)
pred_alr_Clay_lab_b &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_lab_b, 
                               <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayerb), 
                               <span class="dt">control =</span> gcntrl)
## predict alr(silt)
pred_alr_Silt_lab_b &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_lab_b, 
                               <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayerb), 
                               <span class="dt">control =</span> gcntrl)

## Back-transfrom to clay, silt and sand contents
dvr.Silt &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Silt_lab_b<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Silt_lab_b<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Silt_lab_b<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvr.Clay &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Clay_lab_b<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Clay_lab_b<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Clay_lab_b<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvn.pred &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>dvr.Silt <span class="op">+</span><span class="st"> </span>dvr.Clay

## Store the back-transformed values
sppredsvalb<span class="op">$</span>Clay &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Clay<span class="op">/</span>dvn.pred)
sppredsvalb<span class="op">$</span>Silt &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Silt<span class="op">/</span>dvn.pred)
sppredsvalb<span class="op">$</span>Sand &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>dvn.pred

## Estimate the validation parameters for
## Clay
spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Clay, sppredsvalb<span class="op">$</span>Clay)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Clay)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Clay)
## Silt
spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Silt, sppredsvalb<span class="op">$</span>Silt)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Silt)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Silt)
## Sand
spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Sand, sppredsvalb<span class="op">$</span>Sand)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Sand)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Sand)</code></pre>
</div>
</div>
<div id="vis-nir-augmented-based-data" class="section level3">
<h3><span class="header-section-number">9.3.2</span> Vis-NIR augmented-based data</h3>
<p>Here, for the spatial predictions in the vis-NIR augmented dataset we use the variogram parameters which include the residual variances of the vis-NIR models. For this we use the <code>param</code>argument of the <code>predict</code> function in the <code>georob</code> pacakge.
#### Layer A
Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_Ca_spec_a &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_spec_a, 
                          <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayera), 
                          <span class="dt">control =</span> gcntrl,
                          <span class="dt">param =</span> <span class="kw">unlist</span>(variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>, varparamames]))


sppredsvala<span class="op">$</span>Ca_spec &lt;-<span class="st"> </span>pred_Ca_spec_a<span class="op">$</span>pred<span class="op">$</span>pred

spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Ca, sppredsvala<span class="op">$</span>Ca_spec)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Ca_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Ca_spec)</code></pre>
<p>Estimation of clay, silt and sand contents from the predictions of <span class="math inline">\(alr(clay)\)</span> and <span class="math inline">\(alr(silt)\)</span>…</p>
<pre class="sourceCode r"><code class="sourceCode r">## predict alr(clay)
pred_alr_Clay_spec_a &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_spec_a, 
                                <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayera), 
                                <span class="dt">control =</span> gcntrl,
                                <span class="dt">param =</span> <span class="kw">unlist</span>(variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>, varparamames]))
## predict alr(silt)
pred_alr_Silt_spec_a &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_spec_a, 
                                <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayera), 
                                <span class="dt">control =</span> gcntrl,
                                <span class="dt">param =</span> <span class="kw">unlist</span>(variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>, varparamames]))

## Back-transfrom to clay, silt and sand contents
dvr.Silt &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Silt_spec_a<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Silt_spec_a<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Silt_spec_a<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvr.Clay &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Clay_spec_a<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Clay_spec_a<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Clay_spec_a<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvn.pred &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>dvr.Silt <span class="op">+</span><span class="st"> </span>dvr.Clay

## Store the back-transformed values
sppredsvala<span class="op">$</span>Clay_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Clay<span class="op">/</span>dvn.pred)
sppredsvala<span class="op">$</span>Silt_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Silt<span class="op">/</span>dvn.pred)
sppredsvala<span class="op">$</span>Sand_spec &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>dvn.pred

## Estimate the validation parameters for
## Clay
spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Clay, sppredsvala<span class="op">$</span>Clay_spec)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Clay_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Clay_spec)
## Silt
spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Silt, sppredsvala<span class="op">$</span>Silt_spec)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Silt_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Silt_spec)
## Sand
spvala<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayera<span class="op">$</span>Sand, sppredsvala<span class="op">$</span>Sand_spec)<span class="op">^</span><span class="dv">2</span>
spvala<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayera<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Sand_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvala<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayera<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvala<span class="op">$</span>Sand_spec)</code></pre>
<div id="layer-b-3" class="section level4">
<h4><span class="header-section-number">9.3.2.1</span> Layer B</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_Ca_spec_b &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_spec_b, 
                          <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayerb), 
                          <span class="dt">control =</span> gcntrl,
                          <span class="dt">param =</span> <span class="kw">unlist</span>(variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>, varparamames]))

sppredsvalb<span class="op">$</span>Ca_spec &lt;-<span class="st"> </span>pred_Ca_spec_b<span class="op">$</span>pred<span class="op">$</span>pred

spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Ca, sppredsvalb<span class="op">$</span>Ca_spec)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Ca_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Ca_spec)</code></pre>
<p>Estimation of clay, silt and sand contents from the predictions of <span class="math inline">\(alr(clay)\)</span> and <span class="math inline">\(alr(silt)\)</span>…</p>
<pre class="sourceCode r"><code class="sourceCode r">## predict alr(clay)
pred_alr_Clay_spec_b &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_spec_b, 
                                <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayerb), 
                                <span class="dt">control =</span> gcntrl,
                                <span class="dt">param =</span> <span class="kw">unlist</span>(variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>, varparamames]))
## predict alr(silt)
pred_alr_Silt_spec_b &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_spec_b, 
                                <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(vallayerb), 
                                <span class="dt">control =</span> gcntrl,
                                <span class="dt">param =</span> <span class="kw">unlist</span>(variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>, varparamames]))

## Back-transfrom to clay, silt and sand contents
dvr.Silt &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Silt_spec_b<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Silt_spec_b<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Silt_spec_b<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvr.Clay &lt;-<span class="st"> </span><span class="kw">exp</span>(pred_alr_Clay_spec_b<span class="op">$</span>pred<span class="op">$</span>pred <span class="op">+</span><span class="st"> </span>(<span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>(pred_alr_Clay_spec_b<span class="op">$</span>pred<span class="op">$</span>var.target <span class="op">-</span><span class="st"> </span>pred_alr_Clay_spec_b<span class="op">$</span>pred<span class="op">$</span>cov.pred.target)))
dvn.pred &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>dvr.Silt <span class="op">+</span><span class="st"> </span>dvr.Clay

## Store the back-transformed values
sppredsvalb<span class="op">$</span>Clay_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Clay<span class="op">/</span>dvn.pred)
sppredsvalb<span class="op">$</span>Silt_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(dvr.Silt<span class="op">/</span>dvn.pred)
sppredsvalb<span class="op">$</span>Sand_spec &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>dvn.pred

## Estimate the validation parameters for
## Clay
spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Clay, sppredsvalb<span class="op">$</span>Clay_spec)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Clay_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Clay_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Clay_spec)
## Silt
spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Silt, sppredsvalb<span class="op">$</span>Silt_spec)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Silt_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Silt_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Silt_spec)
## Sand
spvalb<span class="op">$</span>R2[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(vallayerb<span class="op">$</span>Sand, sppredsvalb<span class="op">$</span>Sand_spec)<span class="op">^</span><span class="dv">2</span>
spvalb<span class="op">$</span>RMSE[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>((vallayerb<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Sand_spec)<span class="op">^</span><span class="dv">2</span>)<span class="op">^</span><span class="fl">0.5</span>
spvalb<span class="op">$</span>ME[spvala<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Sand_spec&quot;</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(vallayerb<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>sppredsvalb<span class="op">$</span>Sand_spec)</code></pre>
</div>
</div>
</div>
<div id="mapping" class="section level2">
<h2><span class="header-section-number">9.4</span> Mapping</h2>
<p>Now that we have validated the spatial models for both laboratory data and vis-NIR augmented data, we proceed to produce the maps of each property at each layer.
First we have to read the polygon corresponding to the study area. Download the polygon to your working directory.
This is a <code>R</code> object of class (<code>SpatialPolygonsDataFrame</code> of the package <code>sp</code>) which contains the polygon of the study area. Click <a href="https://github.com/l-ramirez-lopez/VNIR_spectroscopy_for_robust_soil_mapping/raw/master/polygon.rds">here</a> to download it. If you saved the file in your working directory you can:</p>
<pre class="sourceCode r"><code class="sourceCode r">polyfile &lt;-<span class="st"> </span><span class="kw">file</span>(<span class="st">&quot;polygon.rds&quot;</span>)
shape &lt;-<span class="st"> </span><span class="kw">readRDS</span>(polyfile)
shape</code></pre>
<p>or…</p>
<pre class="sourceCode r"><code class="sourceCode r">polyfile &lt;-<span class="st"> </span><span class="kw">file</span>(<span class="st">&quot;https://github.com/l-ramirez-lopez/VNIR_spectroscopy_for_robust_soil_mapping/raw/master/polygon.rds&quot;</span>)
shape &lt;-<span class="st"> </span><span class="kw">readRDS</span>(polyfile)
shape</code></pre>
<p>Now create a template for the spatial predictions</p>
<pre class="sourceCode r"><code class="sourceCode r">## function to convert polygon to raster
pol2raster &lt;-<span class="cf">function</span>(r,  <span class="dt">nrows =</span> <span class="dv">10</span>, <span class="dt">ncols =</span> <span class="dv">10</span>){
  ext&lt;-<span class="kw">raster</span>(<span class="kw">extent</span>(r), nrows, ncols)
  <span class="kw">crs</span>(ext) &lt;-<span class="st"> </span><span class="kw">crs</span>(r)
  fr &lt;-<span class="st"> </span><span class="kw">rasterize</span>(r, ext, <span class="dt">field =</span> <span class="dv">1</span>, <span class="dt">update =</span> <span class="ot">TRUE</span>)
  <span class="kw">return</span>(fr)
}

rncol &lt;-<span class="st"> </span>(<span class="kw">extent</span>(shape)<span class="op">@</span>ymax <span class="op">-</span><span class="st"> </span><span class="kw">extent</span>(shape)<span class="op">@</span>ymin)<span class="op">/</span><span class="dv">10</span>
rnrow &lt;-<span class="st"> </span>(<span class="kw">extent</span>(shape)<span class="op">@</span>xmax <span class="op">-</span><span class="st"> </span><span class="kw">extent</span>(shape)<span class="op">@</span>xmin)<span class="op">/</span><span class="dv">10</span>

rasg &lt;-<span class="st"> </span><span class="kw">pol2raster</span>(shape, rncol, rnrow)

## resolution
## here you can choose the resolution for the predicted maps
## for our paper we set this value to 10, however here we 
## will set it to 50 for the sake of memory
## if you have a decent machine you can go finer
mresolution &lt;-<span class="st"> </span><span class="dv">50</span>

rasg &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">resample</span>(rasg, 
                         <span class="kw">raster</span>(<span class="dt">resolution =</span> mresolution, <span class="dt">ext =</span> <span class="kw">extent</span>(shape)), 
                         <span class="dt">method=</span><span class="st">&quot;ngb&quot;</span>)
rasg
<span class="kw">plot</span>(rasg)

## and here we have our template
sppx &lt;-<span class="st"> </span><span class="kw">as</span>(rasg, <span class="st">&quot;SpatialPixelsDataFrame&quot;</span>)
<span class="kw">colnames</span>(sppx<span class="op">@</span>coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;POINT_X&quot;</span>, <span class="st">&quot;POINT_Y&quot;</span>)</code></pre>
<p>Create a <code>data.frame</code> for each layer to store the predicted values for the maps</p>
<pre class="sourceCode r"><code class="sourceCode r">spatialpredsa &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(sppx), <span class="kw">length</span>(bprops)))
<span class="kw">colnames</span>(spatialpredsa) &lt;-<span class="st"> </span>bprops
spatialpredsb &lt;-<span class="st"> </span>spatialpredsa</code></pre>
<div id="laboratory-based-data-2" class="section level3">
<h3><span class="header-section-number">9.4.1</span> Laboratory-based data</h3>
<div id="layer-a-3" class="section level4">
<h4><span class="header-section-number">9.4.1.1</span> Layer A</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">spatialpredsa<span class="op">$</span>Ca &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_lab_a, <span class="dt">newdata =</span> sppx)<span class="op">$</span>pred</code></pre>
<p>Clay, sand and silt contents..</p>
<pre class="sourceCode r"><code class="sourceCode r">alr_Clay_lab_a_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_lab_a, <span class="dt">newdata =</span> sppx)
alr_Silt_lab_a_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_lab_a, <span class="dt">newdata =</span> sppx)

spatialpredsa<span class="op">$</span>Clay &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_a_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_a_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_a_map<span class="op">$</span>pred))
spatialpredsa<span class="op">$</span>Silt &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_a_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_a_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_a_map<span class="op">$</span>pred))
spatialpredsa<span class="op">$</span>Sand &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_a_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_a_map<span class="op">$</span>pred))</code></pre>
</div>
<div id="layer-b-4" class="section level4">
<h4><span class="header-section-number">9.4.1.2</span> Layer B</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">spatialpredsb<span class="op">$</span>Ca &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_lab_b, <span class="dt">newdata =</span> sppx)<span class="op">$</span>pred</code></pre>
<p>Clay, sand and silt contents..</p>
<pre class="sourceCode r"><code class="sourceCode r">alr_Clay_lab_b_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_lab_b, <span class="dt">newdata =</span> sppx)
alr_Silt_lab_b_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_lab_b, sppx)

spatialpredsb<span class="op">$</span>Clay &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_b_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_b_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_b_map<span class="op">$</span>pred))
spatialpredsb<span class="op">$</span>Silt &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_b_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_b_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_b_map<span class="op">$</span>pred))
spatialpredsb<span class="op">$</span>Sand &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_lab_b_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_lab_b_map<span class="op">$</span>pred))</code></pre>
</div>
</div>
<div id="vis-nir-augmented-based-data-1" class="section level3">
<h3><span class="header-section-number">9.4.2</span> Vis-NIR augmented-based data</h3>
<div id="layer-a-4" class="section level4">
<h4><span class="header-section-number">9.4.2.1</span> Layer A</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">spatialpredsa<span class="op">$</span>Ca_spec &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_spec_a, 
                            <span class="dt">newdata =</span> sppx, 
                            <span class="dt">param =</span> <span class="kw">unlist</span>(variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>, varparamames]))<span class="op">$</span>pred</code></pre>
<p>Clay, sand and silt contents..</p>
<pre class="sourceCode r"><code class="sourceCode r">alr_Clay_spec_a_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_spec_a, 
                               <span class="dt">newdata =</span> sppx,
                               <span class="dt">param =</span> <span class="kw">unlist</span>(variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>, varparamames]))
alr_Silt_spec_a_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_spec_a, 
                               <span class="dt">newdata =</span> sppx, 
                               <span class="dt">param =</span> <span class="kw">unlist</span>(variogtablea[variogtablea<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>, varparamames]))

spatialpredsa<span class="op">$</span>Clay_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_a_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_a_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_a_map<span class="op">$</span>pred))
spatialpredsa<span class="op">$</span>Silt_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_a_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_a_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_a_map<span class="op">$</span>pred))
spatialpredsa<span class="op">$</span>Sand_spec &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_a_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_a_map<span class="op">$</span>pred))</code></pre>
</div>
<div id="layer-b-5" class="section level4">
<h4><span class="header-section-number">9.4.2.2</span> Layer B</h4>
<p>Exchangeable Ca<sup>2+</sup>…</p>
<pre class="sourceCode r"><code class="sourceCode r">spatialpredsb<span class="op">$</span>Ca_spec &lt;-<span class="st"> </span><span class="kw">predict</span>(Ca_spec_b, 
                                 <span class="dt">newdata =</span> sppx, 
                                 <span class="dt">param =</span> <span class="kw">unlist</span>(variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;Ca_spec&quot;</span>, varparamames]))<span class="op">$</span>pred</code></pre>
<p>Clay, sand and silt contents..</p>
<pre class="sourceCode r"><code class="sourceCode r">alr_Clay_spec_b_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Clay_spec_b, 
                               <span class="dt">newdata =</span> sppx,
                               <span class="dt">param =</span> <span class="kw">unlist</span>(variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Silt_spec&quot;</span>, varparamames]))
alr_Silt_spec_b_map &lt;-<span class="st"> </span><span class="kw">predict</span>(alr_Silt_spec_b, 
                               <span class="dt">newdata =</span> sppx,
                               <span class="dt">param =</span> <span class="kw">unlist</span>(variogtableb[variogtableb<span class="op">$</span>properties <span class="op">==</span><span class="st"> &quot;alr_Clay_spec&quot;</span>, varparamames]))

spatialpredsb<span class="op">$</span>Clay_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_b_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_b_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_b_map<span class="op">$</span>pred))
spatialpredsb<span class="op">$</span>Silt_spec &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_b_map<span class="op">$</span>pred)<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_b_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_b_map<span class="op">$</span>pred))
spatialpredsb<span class="op">$</span>Sand_spec &lt;-<span class="st"> </span><span class="dv">100</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Silt_spec_b_map<span class="op">$</span>pred) <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(alr_Clay_spec_b_map<span class="op">$</span>pred))</code></pre>
</div>
</div>
<div id="plots" class="section level3">
<h3><span class="header-section-number">9.4.3</span> Plots</h3>
<pre class="sourceCode r"><code class="sourceCode r">## compute the differences between maps (layer)
spatialpredsa<span class="op">$</span>Cadiff &lt;-<span class="st"> </span>spatialpredsa<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>spatialpredsa<span class="op">$</span>Ca_spec 
spatialpredsa<span class="op">$</span>Claydiff &lt;-<span class="st"> </span>spatialpredsa<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>spatialpredsa<span class="op">$</span>Clay_spec 
spatialpredsa<span class="op">$</span>Siltdiff &lt;-<span class="st"> </span>spatialpredsa<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>spatialpredsa<span class="op">$</span>Silt_spec
spatialpredsa<span class="op">$</span>Sanddiff &lt;-<span class="st"> </span>spatialpredsa<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>spatialpredsa<span class="op">$</span>Sand_spec

## compute the differences between maps (layer B)
spatialpredsb<span class="op">$</span>Cadiff &lt;-<span class="st"> </span>spatialpredsb<span class="op">$</span>Ca <span class="op">-</span><span class="st"> </span>spatialpredsb<span class="op">$</span>Ca_spec 
spatialpredsb<span class="op">$</span>Claydiff &lt;-<span class="st"> </span>spatialpredsb<span class="op">$</span>Clay <span class="op">-</span><span class="st"> </span>spatialpredsb<span class="op">$</span>Clay_spec 
spatialpredsb<span class="op">$</span>Siltdiff &lt;-<span class="st"> </span>spatialpredsb<span class="op">$</span>Silt <span class="op">-</span><span class="st"> </span>spatialpredsb<span class="op">$</span>Silt_spec
spatialpredsb<span class="op">$</span>Sanddiff &lt;-<span class="st"> </span>spatialpredsb<span class="op">$</span>Sand <span class="op">-</span><span class="st"> </span>spatialpredsb<span class="op">$</span>Sand_spec</code></pre>
<p>Create a new <code>data.frame</code> for plotting purposes</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_layer_a &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rbind</span>(sppx<span class="op">@</span>coords, 
                                 sppx<span class="op">@</span>coords, 
                                 sppx<span class="op">@</span>coords),
                           <span class="dt">layer =</span> <span class="st">&quot;Depth A (0 - 0.2 m)&quot;</span>,
                           <span class="dt">method =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;Laboratory-based&quot;</span>, <span class="kw">nrow</span>(spatialpredsa)), 
                                      <span class="kw">rep</span>(<span class="st">&quot;vis-NIR augmented&quot;</span>,<span class="kw">nrow</span>(spatialpredsa)),
                                      <span class="kw">rep</span>(<span class="st">&quot;Differences between maps&quot;</span>, <span class="kw">nrow</span>(spatialpredsa))), 
                           <span class="dt">Ca =</span> <span class="kw">unlist</span>(spatialpredsa[,<span class="kw">c</span>(<span class="st">&quot;Ca&quot;</span>, <span class="st">&quot;Ca_spec&quot;</span>, <span class="st">&quot;Cadiff&quot;</span>)]),
                           <span class="dt">Clay =</span> <span class="kw">unlist</span>(spatialpredsa[,<span class="kw">c</span>(<span class="st">&quot;Clay&quot;</span>, <span class="st">&quot;Clay_spec&quot;</span>, <span class="st">&quot;Claydiff&quot;</span>)]),
                           <span class="dt">Silt =</span> <span class="kw">unlist</span>(spatialpredsa[,<span class="kw">c</span>(<span class="st">&quot;Silt&quot;</span>, <span class="st">&quot;Silt_spec&quot;</span>, <span class="st">&quot;Siltdiff&quot;</span>)]),
                           <span class="dt">Sand =</span> <span class="kw">unlist</span>(spatialpredsa[,<span class="kw">c</span>(<span class="st">&quot;Sand&quot;</span>, <span class="st">&quot;Sand_spec&quot;</span>, <span class="st">&quot;Sanddiff&quot;</span>)]))

pred_layer_b &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rbind</span>(sppx<span class="op">@</span>coords, 
                                 sppx<span class="op">@</span>coords, 
                                 sppx<span class="op">@</span>coords),
                           <span class="dt">layer =</span> <span class="st">&quot;Depth B (0.8 - 1.0 m)&quot;</span>,
                           <span class="dt">method =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;Laboratory-based&quot;</span>, <span class="kw">nrow</span>(spatialpredsb)), 
                                      <span class="kw">rep</span>(<span class="st">&quot;vis-NIR augmented&quot;</span>,<span class="kw">nrow</span>(spatialpredsb)),
                                      <span class="kw">rep</span>(<span class="st">&quot;Differences between maps&quot;</span>, <span class="kw">nrow</span>(spatialpredsb))), 
                           <span class="dt">Ca =</span> <span class="kw">unlist</span>(spatialpredsb[,<span class="kw">c</span>(<span class="st">&quot;Ca&quot;</span>, <span class="st">&quot;Ca_spec&quot;</span>, <span class="st">&quot;Cadiff&quot;</span>)]),
                           <span class="dt">Clay =</span> <span class="kw">unlist</span>(spatialpredsb[,<span class="kw">c</span>(<span class="st">&quot;Clay&quot;</span>, <span class="st">&quot;Clay_spec&quot;</span>, <span class="st">&quot;Claydiff&quot;</span>)]),
                           <span class="dt">Silt =</span> <span class="kw">unlist</span>(spatialpredsb[,<span class="kw">c</span>(<span class="st">&quot;Silt&quot;</span>, <span class="st">&quot;Silt_spec&quot;</span>, <span class="st">&quot;Siltdiff&quot;</span>)]),
                           <span class="dt">Sand =</span> <span class="kw">unlist</span>(spatialpredsb[,<span class="kw">c</span>(<span class="st">&quot;Sand&quot;</span>, <span class="st">&quot;Sand_spec&quot;</span>, <span class="st">&quot;Sanddiff&quot;</span>)]))

finalmapping &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rbind</span>(pred_layer_a, pred_layer_b))</code></pre>
<p>Define palette of color for the plot</p>
<pre class="sourceCode r"><code class="sourceCode r">myPalette &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dv">11</span>, <span class="st">&quot;Spectral&quot;</span>)), <span class="dt">space =</span> <span class="st">&quot;Lab&quot;</span>)</code></pre>
<p>Define some ggplot parameters common to all plots</p>
<pre class="sourceCode r"><code class="sourceCode r">gfg &lt;-<span class="st"> </span><span class="kw">facet_grid</span>(layer <span class="op">~</span><span class="st"> </span>method)
gscf &lt;-<span class="st"> </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours =</span> <span class="kw">myPalette</span>(<span class="dv">30</span>))
gcoord &lt;-<span class="st"> </span><span class="kw">coord_equal</span>() 
gtheme &lt;-<span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;top&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.title.y =</span> <span class="kw">element_text</span>( <span class="dt">colour =</span> <span class="kw">grey</span>(<span class="fl">0.2</span>), <span class="dt">size=</span><span class="dv">25</span>),
        <span class="dt">axis.text.y  =</span> <span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">0</span>, <span class="dt">vjust =</span><span class="fl">0.5</span>, <span class="dt">hjust =</span><span class="fl">0.5</span>, <span class="dt">size=</span><span class="dv">16</span>), 
        <span class="dt">legend.title =</span> <span class="kw">element_text</span>( <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">size=</span><span class="dv">25</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_text</span>( <span class="dt">colour =</span> <span class="kw">grey</span>(<span class="fl">0.2</span>), <span class="dt">size=</span><span class="dv">25</span>),
        <span class="dt">axis.text.x  =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">0</span>, <span class="dt">vjust=</span><span class="dv">0</span>, <span class="dt">size=</span><span class="dv">16</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.text =</span> <span class="kw">element_text</span>( <span class="dt">colour =</span> <span class="kw">grey</span>(<span class="fl">0.2</span>), <span class="dt">size=</span><span class="dv">15</span>),
        <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="fl">0.95</span>, <span class="st">&quot;cm&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;grey&quot;</span>), 
        <span class="dt">strip.text.x =</span> <span class="kw">element_text</span>( <span class="dt">size =</span> <span class="dv">25</span>, <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">angle =</span> <span class="dv">0</span>),
        <span class="dt">strip.text.y =</span> <span class="kw">element_text</span>( <span class="dt">size =</span> <span class="dv">25</span>, <span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">angle =</span> <span class="dv">-90</span>)) 
glabs &lt;-<span class="st"> </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Northings /m&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Eastings /m&quot;</span>)
Define palette of color <span class="cf">for</span> the plot</code></pre>
<p>Create the maps for Ca<sup>2+</sup></p>
<pre class="sourceCode r"><code class="sourceCode r">ca_map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">!=</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                 <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Ca)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;&quot;</span>, Ca<span class="op">^</span><span class="st">&quot;++&quot;</span>, <span class="st">&quot; &quot;</span> <span class="op">/</span>mmol[c], kg<span class="op">^-</span><span class="dv">1</span>, <span class="st">&quot; &quot;</span>))))


ca_map_diff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">==</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                      <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Ca)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Difference&quot;</span>, <span class="st">&quot; &quot;</span> <span class="op">/</span>mmol[c], kg<span class="op">^-</span><span class="dv">1</span>, <span class="st">&quot; &quot;</span>))))

ca_map
ca_map_diff</code></pre>
<p>Create the maps for <span class="math inline">\(Clay\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">Clay_map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">!=</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                 <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Clay)) <span class="op">+</span><span class="st"> </span>
gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span>
<span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="st">&quot;Clay content, % &quot;</span>)) 


Clay_map_diff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">==</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                      <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Clay)) <span class="op">+</span><span class="st"> </span>
gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span><span class="st"> </span>
<span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="st">&quot;Difference, %&quot;</span>))

Clay_map
Clay_map_diff</code></pre>
<p>Create the maps for <span class="math inline">\(Silt\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">Silt_map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">!=</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                 <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Silt)) <span class="op">+</span><span class="st"> </span>
gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span>
<span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="st">&quot;Silt content, % &quot;</span>)) 


Silt_map_diff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">==</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                      <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Silt)) <span class="op">+</span><span class="st"> </span>
gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span><span class="st"> </span>
<span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="st">&quot;Difference, %&quot;</span>))

Silt_map
Silt_map_diff</code></pre>
<p>Create the maps for <span class="math inline">\(Sand\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r">Sand_map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">!=</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                 <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Sand)) <span class="op">+</span><span class="st"> </span>
gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span>
<span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="st">&quot;Sand content, % &quot;</span>)) 


Sand_map_diff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(finalmapping[finalmapping<span class="op">$</span>method <span class="op">==</span><span class="st"> &quot;Differences between maps&quot;</span>,], 
                      <span class="kw">aes</span>(POINT_X, POINT_Y)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Sand)) <span class="op">+</span><span class="st"> </span>
gfg <span class="op">+</span><span class="st"> </span>gscf <span class="op">+</span><span class="st"> </span>gcoord <span class="op">+</span><span class="st"> </span>gtheme <span class="op">+</span><span class="st"> </span>glabs <span class="op">+</span><span class="st"> </span>
<span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colourbar</span>(<span class="dt">title =</span> <span class="st">&quot;Difference, %&quot;</span>))

Sand_map
Sand_map_diff</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="prepare-the-vis-nir-augmented-dataset.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/09-spatialmodelling.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["soilmappingwithvnir.pdf", "soilmappingwithvnir.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
